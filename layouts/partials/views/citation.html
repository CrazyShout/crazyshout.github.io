{{/* 覆写主题的 citation 视图（单文件版）
   - 左侧缩略图：等比缩放（Resize），不裁剪
   - 右侧：标题 / 作者（admin 加粗，显示作者档案名）/ 会议简称
   - 底部：链接徽章（带小图标）
*/}}

{{- $fragment := .fragment | default "item" -}}

{{- if eq $fragment "start" -}}
  <div class="space-y-6">
{{- else if eq $fragment "end" -}}
  </div>
{{- else -}}
  {{- $item := .item -}}

  {{/* 1) 缩略图：优先匹配 featured.*；等比缩放，不裁剪 */}}
  {{- $img := or ($item.Resources.GetMatch "featured.*") ($item.Resources.GetMatch "*featured*") -}}

  <div class="flex gap-5 items-start">
    {{ with $img }}
      {{ $thumb := .Resize "320x" }}  {{/* 源图生成 640 宽，下面展示 320 宽 */}}
      <a href="{{ $item.RelPermalink }}" class="shrink-0">
        <img src="{{ $thumb.RelPermalink }}" alt="{{ $item.Title }}"
             class="rounded-md w-[320px] h-auto object-contain" loading="lazy">
      </a>
    {{ end }}

    <div class="min-w-0">
      {{/* 2) 标题 */}}
      <div class="font-semibold">
        <a href="{{ $item.RelPermalink }}" class="hover:underline">
          {{ $item.Title }}
        </a>
      </div>

      {{/* 3) 作者（把 authors 中的用户名映射为作者档案标题；admin/superuser 加粗） */}}
      {{ $authorPieces := slice }}
      {{ range $name := $item.Params.authors }}
        {{- $p := site.GetPage (printf "authors/%s" $name) -}}
        {{- if $p -}}
          {{- $disp := (or $p.Params.title $p.Title) -}}
          {{- $isSuper := (or $p.Params.superuser false) -}}
          {{- $html := cond $isSuper (printf "<strong>%s</strong>" $disp) $disp | safeHTML -}}
          {{- $authorPieces = $authorPieces | append $html -}}
        {{- else -}}
          {{- $authorPieces = $authorPieces | append $name -}}
        {{- end -}}
      {{- end -}}
      {{ $authorsHTML := delimit $authorPieces ", " | safeHTML }}

      {{/* 4) 会议（读取 -> 组装 -> 清洗；年份放最后） */}}
      {{- $short := $item.Param "publication_short" | default "" -}}
      {{- $full  := $item.Param "publication"       | default "" -}}
      
      {{- $venueRaw := "" -}}
      {{- if and $short $full -}}
        {{- if ne $short $full -}}
          {{- $venueRaw = printf "%s (%s)" $full $short -}}   {{/* 全称(简称)；想反过来就调顺序 */}}
        {{- else -}}
          {{- $venueRaw = $short -}}
        {{- end -}}
      {{- else if $short -}}
        {{- $venueRaw = $short -}}
      {{- else if $full -}}
        {{- $venueRaw = $full -}}
      {{- end -}}
      
      {{/* 统一清洗：去 markdown/html、去前缀 In、折叠空白、两端裁剪 */}}
      {{- $venue := $venueRaw -}}
      
      {{- $year := $item.Date | time.Format "2006" -}}
      
      <div class="text-sm opacity-80 mt-1">
        {{ $authorsHTML }}.
        {{- if $venue -}} In <em>{{ $venue }}</em>.{{- end -}}
        {{- if $year  -}} {{ $year }}.{{- end -}}
      </div>
      
      {{ warnf "PUBDEBUG page=%s short=%q full=%q venueRaw=%q venue=%q"
          ($item.RelPermalink | default "n/a") $short $full $venueRaw $venue }}
      

      {{/* 5) 链接徽章区（只在存在任意徽章时渲染；每项都做判空） */}}
      {{- $links := slice -}}

      {{- $cite := $item.Resources.GetMatch "cite.*" -}}
      {{- with $cite -}}
        {{- $links = $links | append (dict "href" .RelPermalink "label" "CITE" "icon" "📄") -}}
      {{- end -}}

      {{- with ($item.Param "url_pdf") -}}
        {{- $u := . | trim " \t\r\n" -}}
        {{- if $u -}}{{- $links = $links | append (dict "href" $u "label" "PDF" "icon" "📕") -}}{{- end -}}
      {{- end -}}

      {{- with ($item.Param "url_code") -}}
        {{- $u := . | trim " \t\r\n" -}}
        {{- if $u -}}{{- $links = $links | append (dict "href" $u "label" "CODE" "icon" "💻") -}}{{- end -}}
      {{- end -}}

      {{- with ($item.Param "url_dataset") -}}
        {{- $u := . | trim " \t\r\n" -}}
        {{- if $u -}}{{- $links = $links | append (dict "href" $u "label" "DATASET" "icon" "🧰") -}}{{- end -}}
      {{- end -}}

      {{- with ($item.Param "url_video") -}}
        {{- $u := . | trim " \t\r\n" -}}
        {{- if $u -}}{{- $links = $links | append (dict "href" $u "label" "VIDEO" "icon" "🎬") -}}{{- end -}}
      {{- end -}}

      {{- with ($item.Param "url_source") -}}
        {{- $u := . | trim " \t\r\n" -}}
        {{- if $u -}}{{- $links = $links | append (dict "href" $u "label" "SOURCE DOCUMENT" "icon" "📄") -}}{{- end -}}
      {{- end -}}

      {{- with ($item.Param "doi") -}}
        {{- $d := . | trim " \t\r\n" -}}
        {{- if $d -}}
          {{- $links = $links | append (dict "href" (printf "https://doi.org/%s" $d) "label" "DOI" "icon" "🔗") -}}
        {{- end -}}
      {{- end -}}

      {{- if gt (len $links) 0 -}}
        <div class="mt-2 flex flex-wrap gap-2 pub-links">
          {{- range $links -}}
            <a class="pub-badge" href="{{ .href | safeURL }}" target="_blank" rel="noopener noreferrer">
              <span class="i">{{ .icon }}</span> {{ .label }}
            </a>
          {{- end -}}
        </div>
      {{- end -}}

    </div>
  </div>
{{- end -}}
